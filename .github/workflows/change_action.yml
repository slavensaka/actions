name: Update CHANGELOG
on:
  pull_request:
    types: [closed]
  push:
    branches:
      - changelog
jobs:
  update_changelog:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3
        #with:
          #ref: changelog  # specify the branch to checkout

      - name: Add entry to CHANGELOG
        run: |
          # get the PR number and title
          pr_number=$(echo "${{ github.event.pull_request.url }}" | cut -d / -f 7)
          pr_title="${{ github.event.pull_request.title }}"
          
          # check if the PR title has a JIRA ticket number at the beginning
          jira_pattern="[A-Z]+\-[0-9]+"
          if [[ $pr_title =~ ^$jira_pattern ]]; then
            jira_ticket="${BASH_REMATCH[0]}"
            jira_link="https://your-jira-instance.com/browse/${jira_ticket}"
          else
            jira_link=""
          fi
          
          # add an entry to the CHANGELOG with a link to the PR and JIRA ticket (if applicable)
          changelog_entry="- [PR #${pr_number}](${{ github.event.pull_request.html_url }}) ${jira_link}${pr_title}"
          printf '%s\n' "## Development" "" "${changelog_entry}" "" "$(cat CHANGELOG.md)" > CHANGELOG.md.new
          mv CHANGELOG.md.new CHANGELOG.md
          git add CHANGELOG.md
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git commit -m "Update CHANGELOG for PR #${pr_number}"
          git push